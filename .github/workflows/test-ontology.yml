name: Test Ontology

on:
  push:
    branches:
      - main
    paths:
      - "scimantic-core/ontology/**"
      - ".github/workflows/deploy-ontology.yml"

permissions:
  contents: write

jobs:
  validate-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ------------------------------------------------------------------------
      # 1. Validation (SHACL)
      # ------------------------------------------------------------------------
      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          cd scimantic-core
          uv sync --all-extras

      - name: Ensure Artifacts are Up-to-Date
        run: |
          cd scimantic-core
          # Regenerate everything from the schema
          uv run gen-all

          # Check if there are any changes. If yes, fail.
          # This forces the user to commit their generated artifacts.
          if [ -n "$(git status --porcelain)" ]; then
            echo "❌ Error: Generated artifacts are out of sync with schema/scimantic.yaml."
            echo "Please run 'uv run gen-all' locally and commit the changes."
            git status
            git diff
            exit 1
          else
            echo "✅ Artifacts are clean and up-to-date."
          fi

      - name: Validate Ontology Syntax & SHACL
        run: |
          cd scimantic-core
          # Syntax check
          uv run python -c "from rdflib import Graph; Graph().parse('ontology/scimantic.ttl', format='turtle')"
          # SHACL check (Scimantic)
          uv run pyshacl -s ontology/shacl/scimantic-shapes.ttl -df turtle ontology/scimantic.ttl

      # ------------------------------------------------------------------------
      # 2. Validation Finished
      #    We do NOT deploy in this workflow. Deployment happens in release-ontology.yml.
      # ------------------------------------------------------------------------

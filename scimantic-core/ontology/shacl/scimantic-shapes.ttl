@prefix sh: <http://www.w3.org/ns/shacl#> .
@prefix scimantic: <http://scimantic.io/> .
@prefix prov: <http://www.w3.org/ns/prov#> .
@prefix urref: <https://raw.githubusercontent.com/adelphi23/urref/469137/URREF.ttl#> .
@prefix dcterms: <http://purl.org/dc/terms/> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix owl: <http://www.w3.org/2002/07/owl#> .

# ------------------------------------------------------------------------------
# Ontology Metadata
# ------------------------------------------------------------------------------

<http://scimantic.io/shapes> a owl:Ontology ;
    dcterms:title "Scimantic Validation Shapes"@en ;
    dcterms:description "SHACL shapes for validating Scimantic data graphs."@en ;
    owl:versionInfo "0.1.0" ;
    owl:versionIRI <http://scimantic.io/v/0.1.0/shacl/scimantic-shapes.ttl> .

# ------------------------------------------------------------------------------
# Entity Generation Constraints
# Enforcing strict activity-entity pairs defined in spec
# ------------------------------------------------------------------------------

scimantic:QuestionGenerationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Question ;
    sh:property [
        sh:path prov:wasGeneratedBy ;
        sh:class scimantic:QuestionFormation ;
        sh:message "A Question must be generated by a QuestionFormation activity." ;
    ] .

scimantic:EvidenceGenerationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Evidence ;
    sh:property [
        sh:path prov:wasGeneratedBy ;
        sh:class scimantic:LiteratureSearch ;
        sh:message "Evidence must be generated by a LiteratureSearch activity." ;
    ] .

scimantic:HypothesisGenerationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Hypothesis ;
    sh:property [
        sh:path prov:wasGeneratedBy ;
        sh:class scimantic:HypothesisFormation ;
        sh:message "A Hypothesis must be generated by a HypothesisFormation activity." ;
    ] .

scimantic:MethodGenerationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:ExperimentalMethod ;
    sh:property [
        sh:path prov:wasGeneratedBy ;
        sh:class scimantic:DesignOfExperiment ;
        sh:message "An ExperimentalMethod must be generated by a DesignOfExperiment activity." ;
    ] .

scimantic:DatasetGenerationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Dataset ;
    sh:property [
        sh:path prov:wasGeneratedBy ;
        sh:class scimantic:Experimentation ;
        sh:message "A Dataset must be generated by an Experimentation activity." ;
    ] .

scimantic:ResultGenerationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Result ;
    sh:property [
        sh:path prov:wasGeneratedBy ;
        sh:class scimantic:Analysis ;
        sh:minCount 1 ;
        sh:message "A Result must be generated by an Analysis activity." ;
    ] .

# ------------------------------------------------------------------------------
# Activity Input Constraints (prov:used)
# ------------------------------------------------------------------------------

scimantic:EvidenceAssessmentInputShape
    a sh:NodeShape ;
    sh:targetClass scimantic:EvidenceAssessment ;
    sh:property [
        sh:path prov:used ;
        sh:class scimantic:Evidence ;
        sh:message "EvidenceAssessment must use Evidence." ;
    ] .

scimantic:HypothesisFormationInputShape
    a sh:NodeShape ;
    sh:targetClass scimantic:HypothesisFormation ;
    sh:property [
        sh:path prov:used ;
        sh:class scimantic:Evidence ;
        sh:message "HypothesisFormation must use Evidence." ;
    ] .

scimantic:DesignOfExperimentInputShape
    a sh:NodeShape ;
    sh:targetClass scimantic:DesignOfExperiment ;
    sh:property [
        sh:path prov:used ;
        sh:class scimantic:Hypothesis ;
        sh:message "DesignOfExperiment must use a Hypothesis." ;
    ] .

scimantic:ExperimentationInputShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Experimentation ;
    sh:property [
        sh:path prov:used ;
        sh:class scimantic:ExperimentalMethod ;
        sh:message "Experimentation must use an ExperimentalMethod." ;
    ] .

scimantic:AnalysisInputShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Analysis ;
    sh:property [
        sh:path prov:used ;
        sh:class scimantic:Dataset ;
        sh:message "Analysis must use a Dataset." ;
    ] .

scimantic:ResultAssessmentInputShape
    a sh:NodeShape ;
    sh:targetClass scimantic:ResultAssessment ;
    sh:property [
        sh:path prov:used ;
        sh:class scimantic:Result ;
        sh:message "ResultAssessment must use a Result." ;
    ] .

# ------------------------------------------------------------------------------
# Property Constraints
# ------------------------------------------------------------------------------

scimantic:MotivatesShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Question ;
    sh:property [
        sh:path scimantic:motivates ;
        sh:class scimantic:LiteratureSearch ;
        sh:message "A Question should motivate a LiteratureSearch." ;
    ] .

scimantic:RefinesShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Result ;
    sh:property [
        sh:path scimantic:refines ;
        sh:class scimantic:Hypothesis ;
        sh:message "A Result Refines a Hypothesis." ;
    ] .

# ------------------------------------------------------------------------------
# Activity Flow Constraints (prov:wasInformedBy)
# ------------------------------------------------------------------------------

scimantic:EvidenceAssessmentFlowShape
    a sh:NodeShape ;
    sh:targetClass scimantic:EvidenceAssessment ;
    sh:property [
        sh:path prov:wasInformedBy ;
        sh:class scimantic:LiteratureSearch ;
        sh:message "EvidenceAssessment follows LiteratureSearch." ;
    ] .

scimantic:HypothesisFormationFlowShape
    a sh:NodeShape ;
    sh:targetClass scimantic:HypothesisFormation ;
    sh:property [
        sh:path prov:wasInformedBy ;
        sh:class scimantic:EvidenceAssessment ;
        sh:message "HypothesisFormation follows EvidenceAssessment." ;
    ] .

scimantic:DesignOfExperimentFlowShape
    a sh:NodeShape ;
    sh:targetClass scimantic:DesignOfExperiment ;
    sh:property [
        sh:path prov:wasInformedBy ;
        sh:class scimantic:HypothesisFormation ;
        sh:message "DesignOfExperiment follows HypothesisFormation." ;
    ] .

scimantic:ExperimentationFlowShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Experimentation ;
    sh:property [
        sh:path prov:wasInformedBy ;
        sh:class scimantic:DesignOfExperiment ;
        sh:message "Experimentation follows DesignOfExperiment." ;
    ] .

scimantic:AnalysisFlowShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Analysis ;
    sh:property [
        sh:path prov:wasInformedBy ;
        sh:class scimantic:Experimentation ;
        sh:message "Analysis follows Experimentation." ;
    ] .

scimantic:ResultAssessmentFlowShape
    a sh:NodeShape ;
    sh:targetClass scimantic:ResultAssessment ;
    sh:property [
        sh:path prov:wasInformedBy ;
        sh:class scimantic:Analysis ;
        sh:message "ResultAssessment follows Analysis." ;
    ] .

# ------------------------------------------------------------------------------
# Entity Derivation Constraints (prov:wasDerivedFrom)
# ------------------------------------------------------------------------------

scimantic:HypothesisDerivationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Hypothesis ;
    sh:property [
        sh:path prov:wasDerivedFrom ;
        sh:class scimantic:Evidence ;
        sh:message "Hypothesis derived from Evidence." ;
    ] .

scimantic:MethodDerivationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:ExperimentalMethod ;
    sh:property [
        sh:path prov:wasDerivedFrom ;
        sh:class scimantic:Hypothesis ;
        sh:message "ExperimentalMethod derived from Hypothesis." ;
    ] .

scimantic:DatasetDerivationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Dataset ;
    sh:property [
        sh:path prov:wasDerivedFrom ;
        sh:class scimantic:ExperimentalMethod ;
        sh:message "Dataset derived from ExperimentalMethod (spec)." ;
    ] .

scimantic:ResultDerivationShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Result ;
    sh:property [
        sh:path prov:wasDerivedFrom ;
        sh:class scimantic:Dataset ;
        sh:message "Result derived from Dataset." ;
    ] .

scimantic:ExperimentalMethodPropertiesShape
    a sh:NodeShape ;
    sh:targetClass scimantic:ExperimentalMethod ;
    sh:property [
        sh:path scimantic:method ;
        sh:datatype xsd:string ;
        sh:minCount 1 ;
        sh:message "An ExperimentalMethod must specify a method name/description." ;
    ] .

scimantic:UncertaintyDomainShape
    a sh:NodeShape ;
    sh:targetSubjectsOf scimantic:hasUncertainty ;
    sh:message "Only Evidence, Result, or Dataset can have attached Uncertainty." ;
    sh:or (
        [ sh:class scimantic:Evidence ]
        [ sh:class scimantic:Result ]
        [ sh:class scimantic:Dataset ]
    ) .


# ------------------------------------------------------------------------------
# Nanopublication Validation (Broad Access)
# ------------------------------------------------------------------------------

scimantic:PublicAccessShape
    a sh:NodeShape ;
    sh:targetClass scimantic:Evidence, scimantic:Hypothesis, scimantic:Result ;
    sh:severity sh:Warning ;
    sh:sparql [
        a sh:SPARQLConstraint ;
        sh:message "Public nanopubs should have a license." ;
        sh:prefixes [
            sh:declare [
                sh:prefix "scimantic" ;
                sh:namespace "http://scimantic.io/"^^xsd:anyURI ;
            ] ;
            sh:declare [
                sh:prefix "dcterms" ;
                sh:namespace "http://purl.org/dc/terms/"^^xsd:anyURI ;
            ]
        ] ;
        sh:select """
            SELECT $this
            WHERE {
                $this scimantic:accessLevel ?level .
                FILTER (?level != "local") .
                FILTER NOT EXISTS { $this dcterms:license ?license }
            }
        """ ;
    ] .
